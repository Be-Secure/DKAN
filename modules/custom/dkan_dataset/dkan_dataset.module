<?php

use Drupal\Core\Entity\EntityInterface;

/**
 * Implements hook_entity_presave().
 *
 * Make sure summary and image are populated.
 */
function dkan_dataset_entity_presave(EntityInterface $entity) {
  if ($entity->getEntityTypeId() != 'node' || $entity->bundle() != 'dataset') {
    return;
  }
  $metadata = json_decode($entity->get('field_json_metadata')->value);
  $entity->setTitle($metadata->title);

  $created = new DateTime();
  $created->setTimestamp($entity->getCreatedTime());
  $metadata->created = $created->format('Y-m-d\TH:i:s');

  $changed = new DateTime();
  $changed->setTimestamp($entity->getChangedTime());
  $metadata->modified = $changed->format('Y-m-d\TH:i:s');

  $metadata->identifier = $entity->uuid();

  $entity->set('field_json_metadata', json_encode($metadata));
}

function dkan_dataset_form_node_dataset_edit_form_alter(&$form, \Drupal\Core\Form\FormStateInterface $form_state) {
  dkan_dataset_form_node_dataset_form_alter($form, $form_state);
}

function dkan_dataset_form_node_dataset_form_alter(&$form, \Drupal\Core\Form\FormStateInterface $form_state) {
  $form['title']['#access'] = FALSE;
}
